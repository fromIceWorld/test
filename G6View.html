<div class="menu">
    <div class="collapse">
        <div class="collapse-header">></div>
        <span style="position: absolute; top: 3px; right: 7px">input</span>
        <div class="collapse-body">
            <div draggable="true">
                <img src="../menu/input.svg" width="160px" id="input" />
            </div>
            <div draggable="true">
                <img src="../menu/radio.svg" width="120px" id="radio" />
            </div>
            <div draggable="true" id="text">
                <span id="text">文本T</span>
            </div>
        </div>
    </div>
</div>
<div id="container" style="width: 1920px; height: 1080px"></div>
<!-- 侧边配置栏 -->
<div class="config-menu">
    <div class="close">
        <span>o</span>
    </div>
    <div class="tabs">
        <span class="tab">config</span>
    </div>
    <div class="tab-body"></div>
</div>
<script src="./g6.min.js"></script>
<script src="./menu/input.js"></script>
<script src="./menu/radio.js"></script>
<script src="./menu/text.js"></script>
<script>
    let dragEvent,
        focusNode,
        tabBody = document.getElementsByClassName('tab-body')[0];
    document.addEventListener('keydown', (event) => {
        event.preventDefault();
    });
    document.addEventListener(
        'dragstart',
        function (event) {
            console.log(event);
            dragEvent = event;
            // 保存拖动元素的引用 (ref.)
            dragEvent = event.target;
            // 使其半透明
            event.target.style.opacity = 0.5;
        },
        false
    );
    document.addEventListener(
        'dragend',
        function (event) {
            // 重置透明度
            event.target.style.opacity = '';
        },
        false
    );
    document.addEventListener(
        'drop',
        function (event) {
            if (event.target.tagName === 'CANVAS') {
                let { offsetX, offsetY } = event,
                    targetX = offsetX,
                    targetY = offsetY;
                console.log(targetX, targetY);
                // 阻止默认动作（如打开一些元素的链接）
                event.preventDefault();
                // 将拖动的元素到所选择的放置目标节点中

                graph.addItem('node', {
                    x: targetX,
                    y: targetY,
                    type: dragEvent.id,
                    config: window[
                        dragEvent.id.toLocaleUpperCase() + '_CONFIG'
                    ],
                    id: String(Math.random()),
                });
                graph.addItem('node', {
                    x: targetX + 10,
                    y: targetY + 10,
                    type: dragEvent.id,
                    config: window[
                        dragEvent.id.toLocaleUpperCase() + '_CONFIG'
                    ],
                    id: String(Math.random()),
                });
                console.log(event);
            }
        },
        false
    );
    const data = {
        nodes: [
            {
                id: 'input',
                description: '单纯的输入框,只携带 placeholder',
                x: 250,
                type: 'input',
                config: INPUT_CONFIG,
                y: 150,
            },
            {
                id: 'radio',
                description: '单纯的输入框,只携带 placeholder',
                x: 170,
                type: 'radio',
                config: RADIO_CONFIG,
                y: 200,
            },
        ],
    };

    const width = document.getElementById('container').scrollWidth;
    const height = document.getElementById('container').scrollHeight || 500;
    const graph = new G6.Graph({
        container: 'container',
        width,
        height,
        // translate the graph to align the canvas's center, support by v3.5.1
        defaultNode: {
            type: 'modelRect',
        },
        modes: {
            default: ['drag-node'],
        },
        nodeStateStyles: {
            hover: {
                lineWidth: 2,
                stroke: '#1890ff',
                fill: '#e6f7ff',
            },
        },
    });

    graph.data(data);
    graph.render();
    graph.on('click', (evt) => {
        const { item } = evt;
        if (item !== focusNode && focusNode) {
            unFocus(focusNode);
            focusNode = null;
        }
    });

    graph.on('node:click', (evt) => {
        const { item, shape } = evt,
            config = item._cfg.model.config;
        focus(item); //focus当前节点
        focusNode = item;
        console.log(item, shape, config);
        tabBody.replaceChildren();
        for (let [key, value] of Object.entries(config)) {
            let row = document.createElement('div'),
                keyNative = document.createElement('div'),
                colon = document.createElement('span'),
                valueNative = document.createElement('div');
            row.setAttribute('class', 'config-row');
            colon.setAttribute('class', 'config-colon');
            colon.appendChild(new Text(' :  '));
            keyNative.setAttribute('class', 'style-key');
            valueNative.setAttribute('class', 'style-value');
            valueNative.setAttribute('contenteditable', 'true');
            valueNative.addEventListener('blur', (e) => {
                shape.attr(key, valueNative.childNodes[0].nodeValue);
                config[key] = valueNative.childNodes[0].nodeValue;
            });
            keyNative.appendChild(new Text(key));
            valueNative.appendChild(new Text(value));
            row.append(keyNative, colon, valueNative);
            tabBody.appendChild(row);
        }
    });
    graph.on('node:mouseenter', (evt) => {
        const { item } = evt;
        focus(item);
    });

    graph.on('node:mouseleave', (evt) => {
        const { item } = evt;
        if (focusNode !== item) {
            unFocus(item);
        }
    });
    graph.on('keydown', (evt) => {
        const { item } = evt;
        console.log('keyup', evt);
        if (evt.keyCode === 46) {
            //delete
            graph.removeItem(focusNode);
            focusNode = null;
        } else if (evt.keyCode >= 37 && evt.keyCode <= 40) {
            // 左上右下
            if (focusNode) {
                let { x, y } = focusNode._cfg.model;
                switch (evt.keyCode) {
                    case 37:
                        x -= 10;
                        break;
                    case 38:
                        y -= 10;
                        break;
                    case 39:
                        x += 10;
                        break;
                    case 40:
                        y += 10;
                        break;
                }
                let model = focusNode._cfg.model;
                graph.updateItem(focusNode, {
                    ...model,
                    x,
                    y,
                });
                evt.preventDefault();
                evt.stopPropagation();
                evt.bubbles = false;

                // graph.removeItem(focusNode);
                // focusNode = graph.addItem('node', {
                //     ...model,
                //     x,
                //     y,
                // });
            }
        }
    });
    function focus(item) {
        graph.updateItem(item, {
            style: {
                ...item.style,
                lineWidth: 1,
                stroke: '#1890ff',
                fill: '#00000000',
                radius: 2,
            },
        });
    }
    function unFocus(item) {
        graph.updateItem(item, {
            style: {
                ...item.style,
                lineWidth: 0,
                fill: '#00000000',
            },
        });
    }
</script>
<script>
    let collHeader = document.querySelector('.collapse-header'),
        collBody = document.querySelector('.collapse-body');
    collHeader.addEventListener('click', () => {
        if (collBody.style.display !== 'none') {
            collBody.style.display = 'none';
        } else {
            collBody.style.display = 'block';
        }
    });
</script>
<style>
    foreignObject {
        width: 100%;
        overflow: inherit;
    }
    body {
        margin: 0;
    }
    .collapse-header {
        cursor: pointer;
        background-color: #fafafa;
        padding: 5px;
    }
    .menu {
        width: 200px;
        height: 100%;
        position: absolute;
        border: 1px solid;
    }
    #container {
        border: 1px solid;
        margin-left: 200px;
    }
    .config-menu {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #7e7ef214;
        width: 200px;
        height: 100%;
    }
    .close {
        position: absolute;
        top: 50%;
        left: -12px;
        cursor: pointer;
    }
    .tabs {
        padding-top: 6px;
        margin-bottom: 14px;
    }
    .tab-body {
        font-size: 14px;
        padding: 0 4px;
    }
    .tab {
        border-bottom: 2px solid blue;
        padding: 5px;
        cursor: pointer;
    }
    .tab:hover {
        background-color: #d4d4de;
    }
    .config-menu {
        position: fixed;
        top: 0;
        right: 0;
        background-color: #7e7ef214;
        width: 200px;
        height: 100%;
    }
    .config-row {
        display: flex;
    }
    .config-colon {
        margin: 0 4px 0 2px;
        font-weight: 600;
    }
</style>
